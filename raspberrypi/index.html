<!DOCTYPE html> <!-- HTML5 ë¬¸ì„œ ì„ ì–¸ -->
<html lang="ko"> <!-- í•œêµ­ì–´ ë¬¸ì„œ ì‹œì‘ -->
<head>
    <meta charset="UTF-8"> <!-- ë¬¸ì ì¸ì½”ë”©ì„ UTF-8ë¡œ ì„¤ì • -->
    <title>WebSocket Stream</title> <!-- íƒ­ì— í‘œì‹œë  ì œëª© -->
</head>
<body>
    <h1>ğŸ“· ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</h1> <!-- ìƒë‹¨ í—¤ë“œë¼ì¸ -->

    <!-- ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•  img íƒœê·¸ -->
    <img id="stream" width="320" height="240" />
    <br><br>

    <!-- ììœ¨ì£¼í–‰ ëª¨ë“œ í† ê¸€ ë²„íŠ¼. í´ë¦­ ì‹œ sendAutonomous() ì‹¤í–‰ -->
    <button id="autoBtn" onclick="sendAutonomous()">ğŸ” ììœ¨ì£¼í–‰ ëª¨ë“œ: í™•ì¸ ì¤‘...</button>

    <!-- í˜„ì¬ ë°©í–¥ì„ ë³´ì—¬ì¤„ í…ìŠ¤íŠ¸ -->
    <p id="directionText">â¡ï¸ ë°©í–¥ í™•ì¸ ì¤‘...</p>
    <!-- ì•„ë‘ì´ë…¸ ì—°ê²° ìƒíƒœë¥¼ ë³´ì—¬ì¤„ í…ìŠ¤íŠ¸ -->
    <p id="arduinoText">ğŸ§© ì•„ë‘ì´ë…¸ ì—°ê²° í™•ì¸ ì¤‘...</p>

    <!-- ì‹œë¦¬ì–¼ í†µì‹  ë¡œê·¸ë¥¼ ë³´ì—¬ì£¼ëŠ” ì½ê¸°ì „ìš© textarea -->
    <h3>ğŸ“œ ì‹œë¦¬ì–¼ ì „ì†¡ ë¡œê·¸</h3>
    <textarea id="serialLog" rows="10" cols="40" readonly style="resize: none;"></textarea>

    <script>
        // img ìš”ì†Œë¥¼ ì„ íƒí•˜ì—¬ ë³€ìˆ˜ì— ì €ì¥ (ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ í‘œì‹œìš©)
        const img = document.getElementById("stream");

        // WebSocket ê°ì²´ ìƒì„±, í˜„ì¬ í˜¸ìŠ¤íŠ¸ì˜ 8765 í¬íŠ¸ë¡œ ì—°ê²°
        const ws = new WebSocket("ws://" + location.hostname + ":8765");

        // ììœ¨ì£¼í–‰ ëª¨ë“œ ë²„íŠ¼ ìš”ì†Œ ì„ íƒ
        const autoBtn = document.getElementById("autoBtn");

        // WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        ws.onmessage = (event) => {
            // ìˆ˜ì‹ ëœ ì´ì§„ ë°ì´í„°ë¥¼ Blob(JPEG ì´ë¯¸ì§€)ìœ¼ë¡œ ë³€í™˜
            const blob = new Blob([event.data], { type: "image/jpeg" });
            // Blobì„ ì´ë¯¸ì§€ URLë¡œ ë³€í™˜í•˜ì—¬ <img>ì˜ srcë¡œ ì„¤ì • (ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ)
            img.src = URL.createObjectURL(blob);
        };

        // ììœ¨ì£¼í–‰ ëª¨ë“œ í† ê¸€ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
        async function sendAutonomous() {
            try {
                // /autonomous ì—”ë“œí¬ì¸íŠ¸ë¡œ POST ìš”ì²­ì„ ë³´ë‚´ ììœ¨ì£¼í–‰ ëª¨ë“œë¥¼ í† ê¸€
                await fetch("/autonomous", { method: "POST" });
                // í† ê¸€ í›„ í˜„ì¬ ëª¨ë“œ ìƒíƒœë¥¼ ê°±ì‹ 
                await checkMode();
            } catch {
                // ì‹¤íŒ¨ì‹œ ì½˜ì†”ì— ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
                console.error("âŒ ììœ¨ì£¼í–‰ ëª…ë ¹ ì‹¤íŒ¨");
            }
        }

        // í˜„ì¬ ììœ¨ì£¼í–‰ ëª¨ë“œ ìƒíƒœë¥¼ ì„œë²„ì—ì„œ ë°›ì•„ì™€ ë²„íŠ¼ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        async function checkMode() {
            try {
                // /mode ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ëª¨ë“œ ìƒíƒœ(ON/OFF)ë¥¼ ë°›ì•„ì˜´
                const res = await fetch("/mode");
                // ì‘ë‹µ í…ìŠ¤íŠ¸(ON ë˜ëŠ” OFF)
                const mode = await res.text();
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ í˜„ì¬ ëª¨ë“œ ìƒíƒœë¡œ ê°±ì‹ 
                autoBtn.innerText = `ğŸ” ììœ¨ì£¼í–‰ ëª¨ë“œ: ${mode}`;
            } catch {
                // ì‹¤íŒ¨ì‹œ ë²„íŠ¼ í…ìŠ¤íŠ¸ì— ì˜¤ë¥˜ í‘œì‹œ
                autoBtn.innerText = "âŒ ëª¨ë“œ í™•ì¸ ì‹¤íŒ¨";
            }
        }

        // í˜„ì¬ ë°©í–¥ ì •ë³´ë¥¼ ì„œë²„ì—ì„œ ë°›ì•„ì™€ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        async function checkDirection() {
            try {
                // /status ì—”ë“œí¬ì¸íŠ¸ì—ì„œ í˜„ì¬ ë°©í–¥(STRAIGHT ë“±)ì„ ë°›ì•„ì˜´
                const res = await fetch("/status");
                // ì‘ë‹µ í…ìŠ¤íŠ¸(ë°©í–¥ ì •ë³´)
                const direction = await res.text();
                // ë°©í–¥ í‘œì‹œ í…ìŠ¤íŠ¸ ê°±ì‹ 
                document.getElementById("directionText").innerText = "â¡ï¸ í˜„ì¬ ë°©í–¥: " + direction;
            } catch {
                // ì‹¤íŒ¨ì‹œ ì˜¤ë¥˜ í‘œì‹œ
                document.getElementById("directionText").innerText = "âŒ ë°©í–¥ í™•ì¸ ì‹¤íŒ¨";
            }
        }

        // ì•„ë‘ì´ë…¸ ì—°ê²° ìƒíƒœë¥¼ ë°›ì•„ì™€ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        async function checkArduino() {
            try {
                // /arduino ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì—°ê²° ìƒíƒœ(CONNECTED/DISCONNECTED)ë¥¼ ë°›ì•„ì˜´
                const res = await fetch("/arduino");
                // ì‘ë‹µ í…ìŠ¤íŠ¸(ìƒíƒœ ì •ë³´)
                const status = await res.text();
                // ì—°ê²° ìƒíƒœì— ë”°ë¼ ì´ëª¨ì§€ ì„ íƒ
                const emoji = status === "CONNECTED" ? "âœ…" : "âš ï¸";
                // ìƒíƒœ í…ìŠ¤íŠ¸ì— í‘œì‹œ
                document.getElementById("arduinoText").innerText = `${emoji} ì•„ë‘ì´ë…¸ ìƒíƒœ: ${status}`;
            } catch {
                // ì‹¤íŒ¨ì‹œ ì˜¤ë¥˜ í‘œì‹œ
                document.getElementById("arduinoText").innerText = "âŒ ì•„ë‘ì´ë…¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨";
            }
        }

        // ì‹œë¦¬ì–¼ í†µì‹  ë¡œê·¸ë¥¼ ë°›ì•„ì™€ textareaì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        async function checkSerialLog() {
            try {
                // /serial-log ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ë¡œê·¸ ë°›ì•„ì˜´
                const res = await fetch("/serial-log");
                // ì‘ë‹µ í…ìŠ¤íŠ¸(ë¡œê·¸ ì „ì²´)
                const log = await res.text();
                // textarea ìš”ì†Œ ì„ íƒ
                const logBox = document.getElementById("serialLog");
                // textareaì— ë¡œê·¸ ì¶œë ¥
                logBox.value = log;
                // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ë§¨ ì•„ë˜ë¡œ ì´ë™ì‹œí‚´(ìµœì‹  ë¡œê·¸ê°€ ë³´ì´ë„ë¡)
                logBox.scrollTop = logBox.scrollHeight;

                // ë¡œê·¸ì˜ ë§ˆì§€ë§‰ ì¤„ì„ í™•ì¸í•˜ì—¬ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ì œì–´
                const lines = log.trim().split("\n"); // ì¤„ ë‹¨ìœ„ë¡œ ë¶„í• 
                const last = lines[lines.length - 1] || ""; // ë§ˆì§€ë§‰ ì¤„

                // (recv) aê°€ ìˆ˜ì‹ ëœ ê²½ìš°(ì•„ë‘ì´ë…¸ì—ì„œ ììœ¨ì£¼í–‰ ëª…ë ¹)
                if (last.includes("(recv) a")) {
                    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° í…ìŠ¤íŠ¸ ê°±ì‹ (ìë™)
                    autoBtn.disabled = true;
                    autoBtn.innerText = "ğŸ” ììœ¨ì£¼í–‰ ëª¨ë“œ: ON (ìë™)";
                } else if (last.includes("(recv) n")) {
                    // n(ìˆ˜ë™) ìˆ˜ì‹ ì‹œ ë²„íŠ¼ í™œì„±í™” ë° ëª¨ë“œ ìƒíƒœ ê°±ì‹ 
                    autoBtn.disabled = false;
                    await checkMode();  // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì¬í™•ì¸
                }
            } catch {
                // ì‹¤íŒ¨ì‹œ textareaì— ì˜¤ë¥˜ í‘œì‹œ
                document.getElementById("serialLog").value = "âŒ ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
            }
        }

        // ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœ ì •ë³´ë¥¼ ìë™ ê°±ì‹  (setInterval ì‚¬ìš©)

        setInterval(checkMode, 2000);         // 2ì´ˆë§ˆë‹¤ ììœ¨ì£¼í–‰ ëª¨ë“œ ìƒíƒœ ê°±ì‹ 
        setInterval(checkDirection, 500);     // 0.5ì´ˆë§ˆë‹¤ ë°©í–¥ ì •ë³´ ê°±ì‹ 
        setInterval(checkArduino, 2000);      // 2ì´ˆë§ˆë‹¤ ì•„ë‘ì´ë…¸ ì—°ê²° ìƒíƒœ ê°±ì‹ 
        setInterval(checkSerialLog, 1000);    // 1ì´ˆë§ˆë‹¤ ì‹œë¦¬ì–¼ ë¡œê·¸ ê°±ì‹ 

    </script>
</body>
</html>